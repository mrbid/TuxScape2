/*
    James William Fletcher ( github.com/mrbid )
        June 2024
*/

//#pragma GCC diagnostic ignored "-Wunused-result"
//#pragma GCC diagnostic ignored "-Wtrigraphs"
//#pragma GCC diagnostic ignored "-Wpointer-sign"
const unsigned char icon_image[] = // 16x16 RGBA
  "\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377"
  "\377\377\000\000\000\000\013\001\001\001H\002\002\002N\001\001\001\031\377\377\377\000\377\377\377\000\377"
  "\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377\377"
  "\377\000\377\377\377\000\377\377\377\000\002\002\002\012\002\002\002x\001\001\001\311\001\001\001\350\001"
  "\001\001\352\001\001\001\323\001\001\001\215\001\001\001\035\377\377\377\000\377\377\377\000\377\377"
  "\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\000\000\000\032\001"
  "\001\001\316\001\001\001\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\001\001"
  "\001\351\000\000\000;\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\377"
  "\377\377\000\000\000\000\002\001\001\001\301\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\001\001\001\351\001\001\001\027\377\377\377\000\377"
  "\377\377\000\377\377\377\000\377\377\377\000\001\001\001H\000\000\000\377\000\000\000\377\000\000\000\377"
  "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\001"
  "\001\001\200\377\377\377\000\377\377\377\000\377\377\377\000\377\377\377\000\000\000\000\225"
  "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000"
  "\000\000\377\000\000\000\377\000\000\000\377\000\000\000\312\000\000\000\000\377\377\377\000\377\377\377"
  "\000\377\377\377\000\001\001\001\303\000\000\000\377\000\000\000\377MNO\377\034\034\035\377\000\000\000"
  "\377\000\000\000\377\011\011\012\377QQR\377\013\014\014\377\000\000\000\377\001\001\001\355\001\001\001"
  "\022\377\377\377\000\377\377\377\000\000\000\000\005\001\001\001\334\000\000\000\377xz~\377\377\377"
  "\377\377\353\353\360\377\023\023\023\377\000\000\000\377\276\276\303\377\377\377\377"
  "\377\302\300\300\377\002\001\001\377\000\000\000\374\001\001\001&\377\377\377\000\377\377\377"
  "\000\000\000\000\015\000\000\000\345\007\007\007\377\263\265\272\377(()\377\272\272\277\377nt"
  "|\377\040(\062\377\337\340\350\377''(\377\312\307\305\377\065\064\063\377\000\000"
  "\000\377\001\001\001\064\377\377\377\000\377\377\377\000\001\001\001\020\000\000\000\350\016\017\020\377"
  "\212\214\220\377\000\000\000\377\067\066\067\377\310\240v\377\253|L\377ske\377\000\000"
  "\000\377\211\207\204\377GFC\377\000\000\000\377\000\000\000\065\377\377\377\000\377\377\377"
  "\000\001\001\001\024\000\000\000\356\001\002\002\377\204\215\232\377\060\037\016\377\244Y\006\377\347"
  "|\011\377\360\202\015\377\320n\010\377?\037\002\377\230\236\244\377#%&\377\000\000"
  "\000\377\001\001\001<\377\377\377\000\377\377\377\000\001\001\001\027\000\000\001\361\004\002\000\377\231"
  "k<\377\303n\024\377\310m\015\377\325t\020\377\331v\021\377\340y\020\377\352{\015"
  "\377\335\221G\377\030\021\011\377\000\000\000\377\001\001\001A\377\377\377\000\377\377\377"
  "\000\001\001\001,\000\000\000\375\032\016\001\377\273_\000\377\246X\006\377\266c\014\377\320p\017"
  "\377\327s\017\377\327r\017\377\330r\015\377\360w\000\377W-\004\377\000\000\000\377\001\001"
  "\001[\377\377\377\000\377\377\377\000\001\001\001d\000\000\000\377\001\000\000\377U\064\022\377\240"
  "Y\017\377\260Y\001\377\313m\016\377\322q\017\377\317j\007\377\321k\011\377\224X\036"
  "\377\012\004\000\377\000\000\000\377\000\000\000\230\377\377\377\000\001\001\001\031\001\001\001\306\000\000"
  "\000\377\000\000\000\377\222\230\242\377\327\323\325\377\222d;\377\216G\006\377\226"
  "K\005\377\251d'\377\336\312\273\377\306\315\327\377\006\010\011\377\000\000\000\377\000"
  "\000\000\345\000\000\000N\001\001\001\202\000\000\000\372\000\000\000\377\006\006\006\377\325\325\332\377\362"
  "\367\377\377\337\344\356\377\203dQ\377{T;\377\332\325\325\377\367\377\377"
  "\377\377\374\376\377.--\377\000\000\000\377\000\000\000\377\001\001\001\322";

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
void timestamp(char* ts){const time_t tt=time(0);strftime(ts,16,"%H:%M:%S",localtime(&tt));}
#ifdef WEB
    #include <emscripten.h>
    #include <emscripten/html5.h>
    #define GL_GLEXT_PROTOTYPES
    #define EGL_EGLEXT_PROTOTYPES
#endif
#define GLAD_GL_IMPLEMENTATION
#include "inc/gl.h"
#define GLFW_INCLUDE_NONE
#include "inc/glfw3.h"
#define uint GLuint
#define sint GLint
#define MAX_MODELS 432 // hard limit, be aware and increase if needed
#include "inc/esLuma.h"
#include "assets/high/p0.h"  //0
#include "assets/high/p1.h"  //1
#include "assets/high/p2.h"  //2
#include "assets/high/p3.h"  //3
#include "assets/high/p4.h"  //4
#include "assets/high/p5.h"  //5
#include "assets/high/p6.h"  //6
#include "assets/high/p7.h"  //7
#include "assets/high/p8.h"  //8
#include "assets/high/p9.h"  //9
#include "assets/high/p10.h"  //10
#include "assets/high/p11.h"  //11
#include "assets/high/p12.h"  //12
#include "assets/high/p13.h"  //13
#include "assets/high/p14.h"  //14
#include "assets/high/p15.h"  //15
#include "assets/high/p16.h"  //16
#include "assets/high/p17.h"  //17
#include "assets/high/p18.h"  //18
#include "assets/high/p19.h"  //19
#include "assets/high/p20.h"  //20
#include "assets/high/p21.h"  //21
#include "assets/high/p22.h"  //22
#include "assets/high/p23.h"  //23
#include "assets/high/p24.h"  //24
#include "assets/high/p25.h"  //25
#include "assets/high/p26.h"  //26
#include "assets/high/p27.h"  //27
#include "assets/high/p28.h"  //28
#include "assets/high/p29.h"  //29
#include "assets/high/p30.h"  //30
#include "assets/high/p31.h"  //31
#include "assets/high/p32.h"  //32
#include "assets/high/p33.h"  //33
#include "assets/high/p34.h"  //34
#include "assets/high/p35.h"  //35
#include "assets/high/p36.h"  //36
#include "assets/high/p37.h"  //37
#include "assets/high/p38.h"  //38
#include "assets/high/p39.h"  //39
#include "assets/high/p40.h"  //40
#include "assets/high/p41.h"  //41
#include "assets/high/p42.h"  //42
#include "assets/high/p43.h"  //43
#include "assets/high/p44.h"  //44
#include "assets/high/p45.h"  //45
#include "assets/high/p46.h"  //46
#include "assets/high/p47.h"  //47
#include "assets/high/p48.h"  //48
#include "assets/high/p49.h"  //49
#include "assets/high/p50.h"  //50
#include "assets/high/p51.h"  //51
#include "assets/high/p52.h"  //52
#include "assets/high/p53.h"  //53
#include "assets/high/p54.h"  //54
#include "assets/high/p55.h"  //55
#include "assets/high/p56.h"  //56
#include "assets/high/p57.h"  //57
#include "assets/high/p58.h"  //58
#include "assets/high/p59.h"  //59
#include "assets/high/p60.h"  //60
#include "assets/high/p61.h"  //61
#include "assets/high/p62.h"  //62
#include "assets/high/p63.h"  //63
#include "assets/high/p64.h"  //64
#include "assets/high/p65.h"  //65
#include "assets/high/p66.h"  //66
#include "assets/high/p67.h"  //67
#include "assets/high/p68.h"  //68
#include "assets/high/p69.h"  //69
#include "assets/high/p70.h"  //70
#include "assets/high/p71.h"  //71
#include "assets/high/p72.h"  //72
#include "assets/high/p73.h"  //73
#include "assets/high/p74.h"  //74
#include "assets/high/p75.h"  //75
#include "assets/high/p76.h"  //76
#include "assets/high/p77.h"  //77
#include "assets/high/p78.h"  //78
#include "assets/high/p79.h"  //79
#include "assets/high/p80.h"  //80
#include "assets/high/p81.h"  //81
#include "assets/high/p82.h"  //82
#include "assets/high/p83.h"  //83
#include "assets/high/p84.h"  //84
#include "assets/high/p85.h"  //85
#include "assets/high/p86.h"  //86
#include "assets/high/p87.h"  //87
#include "assets/high/p88.h"  //88
#include "assets/high/p89.h"  //89
#include "assets/high/p90.h"  //90
#include "assets/high/p91.h"  //91
#include "assets/high/p92.h"  //92
#include "assets/high/p93.h"  //93
#include "assets/high/p94.h"  //94
#include "assets/high/p95.h"  //95
#include "assets/high/p96.h"  //96
#include "assets/high/p97.h"  //97
#include "assets/high/p98.h"  //98
#include "assets/high/p99.h"  //99
#include "assets/high/p100.h"  //100
#include "assets/high/p101.h"  //101
#include "assets/high/p102.h"  //102
#include "assets/high/p103.h"  //103
#include "assets/high/p104.h"  //104
#include "assets/high/p105.h"  //105
#include "assets/high/p106.h"  //106
#include "assets/high/p107.h"  //107
#include "assets/high/p108.h"  //108
#include "assets/high/p109.h"  //109
#include "assets/high/p110.h"  //110
#include "assets/high/p111.h"  //111
#include "assets/high/p112.h"  //112
#include "assets/high/p113.h"  //113
#include "assets/high/p114.h"  //114
#include "assets/high/p115.h"  //115
#include "assets/high/p116.h"  //116
#include "assets/high/p117.h"  //117
#include "assets/high/p118.h"  //118
#include "assets/high/p119.h"  //119
#include "assets/high/p120.h"  //120
#include "assets/high/p121.h"  //121
#include "assets/high/p122.h"  //122
#include "assets/high/p123.h"  //123
#include "assets/high/p124.h"  //124
#include "assets/high/p125.h"  //125
#include "assets/high/p126.h"  //126
#include "assets/high/p127.h"  //127
#include "assets/high/p128.h"  //128
#include "assets/high/p129.h"  //129
#include "assets/high/p130.h"  //130
#include "assets/high/p131.h"  //131
#include "assets/high/p132.h"  //132
#include "assets/high/p133.h"  //133
#include "assets/high/p134.h"  //134
#include "assets/high/p135.h"  //135
#include "assets/high/p136.h"  //136
#include "assets/high/p137.h"  //137
#include "assets/high/p138.h"  //138
#include "assets/high/p139.h"  //139
#include "assets/high/p140.h"  //140
#include "assets/high/p141.h"  //141
#include "assets/high/p142.h"  //142
#include "assets/high/p143.h"  //143
#include "assets/high/p144.h"  //144
#include "assets/high/p145.h"  //145
#include "assets/high/p146.h"  //146
#include "assets/high/p147.h"  //147
#include "assets/high/p148.h"  //148
#include "assets/high/p149.h"  //149
#include "assets/high/p150.h"  //150
#include "assets/high/p151.h"  //151
#include "assets/high/p152.h"  //152
#include "assets/high/p153.h"  //153
#include "assets/high/p154.h"  //154
#include "assets/high/p155.h"  //155
#include "assets/high/p156.h"  //156
#include "assets/high/p157.h"  //157
#include "assets/high/p158.h"  //158
#include "assets/high/p159.h"  //159
#include "assets/high/p160.h"  //160
#include "assets/high/p161.h"  //161
#include "assets/high/p162.h"  //162
#include "assets/high/p163.h"  //163
#include "assets/high/p164.h"  //164
#include "assets/high/p165.h"  //165
#include "assets/high/p166.h"  //166
#include "assets/high/p167.h"  //167
#include "assets/high/p168.h"  //168
#include "assets/high/p169.h"  //169
#include "assets/high/p170.h"  //170
#include "assets/high/p171.h"  //171
#include "assets/high/p172.h"  //172
#include "assets/high/p173.h"  //173
#include "assets/high/p174.h"  //174
#include "assets/high/p175.h"  //175
#include "assets/high/p176.h"  //176
#include "assets/high/p177.h"  //177
#include "assets/high/p178.h"  //178
#include "assets/high/p179.h"  //179
#include "assets/high/p180.h"  //180
#include "assets/high/p181.h"  //181
#include "assets/high/p182.h"  //182
#include "assets/high/p183.h"  //183
#include "assets/high/p184.h"  //184
#include "assets/high/p185.h"  //185
#include "assets/high/p186.h"  //186
#include "assets/high/p187.h"  //187
#include "assets/high/p188.h"  //188
#include "assets/high/p189.h"  //189
#include "assets/high/p190.h"  //190
#include "assets/high/p191.h"  //191
#include "assets/high/p192.h"  //192
#include "assets/high/p193.h"  //193
#include "assets/high/p194.h"  //194
#include "assets/high/p195.h"  //195
#include "assets/high/p196.h"  //196
#include "assets/high/p197.h"  //197
#include "assets/high/p198.h"  //198
#include "assets/high/p199.h"  //199
#include "assets/high/p200.h"  //200
#include "assets/high/p201.h"  //201
#include "assets/high/p202.h"  //202
#include "assets/high/p203.h"  //203
#include "assets/high/p204.h"  //204
#include "assets/high/p205.h"  //205
#include "assets/high/p206.h"  //206

#include "assets/high/h0.h"  //207
#include "assets/high/m0.h"  //208
#include "assets/high/l0.h"  //209
#include "assets/high/h1.h"  //210
#include "assets/high/m1.h"  //211
#include "assets/high/l1.h"  //212
#include "assets/high/h2.h"  //213
#include "assets/high/m2.h"  //214
#include "assets/high/l2.h"  //215
#include "assets/high/h3.h"  //216
#include "assets/high/m3.h"  //217
#include "assets/high/l3.h"  //218
#include "assets/high/h4.h"  //219
#include "assets/high/m4.h"  //220
#include "assets/high/l4.h"  //221
#include "assets/high/h5.h"  //222
#include "assets/high/m5.h"  //223
#include "assets/high/l5.h"  //224
#include "assets/high/h6.h"  //225
#include "assets/high/m6.h"  //226
#include "assets/high/l6.h"  //227
#include "assets/high/h7.h"  //228
#include "assets/high/m7.h"  //229
#include "assets/high/l7.h"  //230
#include "assets/high/h8.h"  //231
#include "assets/high/m8.h"  //232
#include "assets/high/l8.h"  //233
#include "assets/high/h9.h"  //234
#include "assets/high/m9.h"  //235
#include "assets/high/l9.h"  //236
#include "assets/high/h10.h"  //237
#include "assets/high/m10.h"  //238
#include "assets/high/l10.h"  //239
#include "assets/high/h11.h"  //240
#include "assets/high/m11.h"  //241
#include "assets/high/l11.h"  //242
#include "assets/high/h12.h"  //243
#include "assets/high/m12.h"  //244
#include "assets/high/l12.h"  //245
#include "assets/high/h13.h"  //246
#include "assets/high/m13.h"  //247
#include "assets/high/l13.h"  //248
#include "assets/high/h14.h"  //249
#include "assets/high/m14.h"  //250
#include "assets/high/l14.h"  //251
#include "assets/high/h15.h"  //252
#include "assets/high/m15.h"  //253
#include "assets/high/l15.h"  //254
#include "assets/high/h16.h"  //255
#include "assets/high/m16.h"  //256
#include "assets/high/l16.h"  //257
#include "assets/high/h17.h"  //258
#include "assets/high/m17.h"  //259
#include "assets/high/l17.h"  //260
#include "assets/high/h18.h"  //261
#include "assets/high/m18.h"  //262
#include "assets/high/l18.h"  //263
#include "assets/high/h19.h"  //264
#include "assets/high/m19.h"  //265
#include "assets/high/l19.h"  //266
#include "assets/high/h20.h"  //267
#include "assets/high/m20.h"  //268
#include "assets/high/l20.h"  //269
#include "assets/high/h21.h"  //270
#include "assets/high/m21.h"  //271
#include "assets/high/l21.h"  //272
#include "assets/high/h22.h"  //273
#include "assets/high/m22.h"  //274
#include "assets/high/l22.h"  //275
#include "assets/high/h23.h"  //276
#include "assets/high/m23.h"  //277
#include "assets/high/l23.h"  //278
#include "assets/high/h24.h"  //279
#include "assets/high/m24.h"  //280
#include "assets/high/l24.h"  //281
#include "assets/high/h25.h"  //282
#include "assets/high/m25.h"  //283
#include "assets/high/l25.h"  //284
#include "assets/high/h26.h"  //285
#include "assets/high/m26.h"  //286
#include "assets/high/l26.h"  //287
#include "assets/high/h27.h"  //288
#include "assets/high/m27.h"  //289
#include "assets/high/l27.h"  //290
#include "assets/high/h28.h"  //291
#include "assets/high/m28.h"  //292
#include "assets/high/l28.h"  //293
#include "assets/high/h29.h"  //294
#include "assets/high/m29.h"  //295
#include "assets/high/l29.h"  //296
#include "assets/high/h30.h"  //297
#include "assets/high/m30.h"  //298
#include "assets/high/l30.h"  //299
#include "assets/high/h31.h"  //300
#include "assets/high/m31.h"  //301
#include "assets/high/l31.h"  //302
#include "assets/high/h32.h"  //303
#include "assets/high/m32.h"  //304
#include "assets/high/l32.h"  //305
#include "assets/high/h33.h"  //306
#include "assets/high/m33.h"  //307
#include "assets/high/l33.h"  //308
#include "assets/high/h34.h"  //309
#include "assets/high/m34.h"  //310
#include "assets/high/l34.h"  //311
#include "assets/high/h35.h"  //312
#include "assets/high/m35.h"  //313
#include "assets/high/l35.h"  //314
#include "assets/high/h36.h"  //315
#include "assets/high/m36.h"  //316
#include "assets/high/l36.h"  //317
#include "assets/high/h37.h"  //318
#include "assets/high/m37.h"  //319
#include "assets/high/l37.h"  //320
#include "assets/high/h38.h"  //321
#include "assets/high/m38.h"  //322
#include "assets/high/l38.h"  //323
#include "assets/high/h39.h"  //324
#include "assets/high/m39.h"  //325
#include "assets/high/l39.h"  //326
#include "assets/high/h40.h"  //327
#include "assets/high/m40.h"  //328
#include "assets/high/l40.h"  //329
#include "assets/high/h41.h"  //330
#include "assets/high/m41.h"  //331
#include "assets/high/l41.h"  //332
#include "assets/high/h42.h"  //333
#include "assets/high/m42.h"  //334
#include "assets/high/l42.h"  //335
#include "assets/high/h43.h"  //336
#include "assets/high/m43.h"  //337
#include "assets/high/l43.h"  //338
#include "assets/high/h44.h"  //339
#include "assets/high/m44.h"  //340
#include "assets/high/l44.h"  //341
#include "assets/high/h45.h"  //342
#include "assets/high/m45.h"  //343
#include "assets/high/l45.h"  //344
#include "assets/high/h46.h"  //345
#include "assets/high/m46.h"  //346
#include "assets/high/l46.h"  //347
#include "assets/high/h47.h"  //348
#include "assets/high/m47.h"  //349
#include "assets/high/l47.h"  //350
#include "assets/high/h48.h"  //351
#include "assets/high/m48.h"  //352
#include "assets/high/l48.h"  //353
#include "assets/high/h49.h"  //354
#include "assets/high/m49.h"  //355
#include "assets/high/l49.h"  //356
#include "assets/high/h50.h"  //357
#include "assets/high/m50.h"  //358
#include "assets/high/l50.h"  //359
#include "assets/high/h51.h"  //360
#include "assets/high/m51.h"  //361
#include "assets/high/l51.h"  //362
#include "assets/high/h52.h"  //363
#include "assets/high/m52.h"  //364
#include "assets/high/l52.h"  //365
#include "assets/high/h53.h"  //366
#include "assets/high/m53.h"  //367
#include "assets/high/l53.h"  //368
#include "assets/high/h54.h"  //369
#include "assets/high/m54.h"  //370
#include "assets/high/l54.h"  //371
#include "assets/high/h55.h"  //372
#include "assets/high/m55.h"  //373
#include "assets/high/l55.h"  //374
#include "assets/high/h56.h"  //375
#include "assets/high/m56.h"  //376
#include "assets/high/l56.h"  //377
#include "assets/high/h57.h"  //378
#include "assets/high/m57.h"  //379
#include "assets/high/l57.h"  //380
#include "assets/high/h58.h"  //381
#include "assets/high/m58.h"  //382
#include "assets/high/l58.h"  //383
#include "assets/high/h59.h"  //384
#include "assets/high/m59.h"  //385
#include "assets/high/l59.h"  //386
#include "assets/high/h60.h"  //387
#include "assets/high/m60.h"  //388
#include "assets/high/l60.h"  //389
#include "assets/high/h61.h"  //390
#include "assets/high/m61.h"  //391
#include "assets/high/l61.h"  //392
#include "assets/high/h62.h"  //393
#include "assets/high/m62.h"  //394
#include "assets/high/l62.h"  //395
#include "assets/high/h63.h"  //396
#include "assets/high/m63.h"  //397
#include "assets/high/l63.h"  //398
#include "assets/high/h64.h"  //399
#include "assets/high/m64.h"  //400
#include "assets/high/l64.h"  //401
#include "assets/high/h65.h"  //402
#include "assets/high/m65.h"  //403
#include "assets/high/l65.h"  //404
#include "assets/high/h66.h"  //405
#include "assets/high/m66.h"  //406
#include "assets/high/l66.h"  //407
#include "assets/high/h67.h"  //408
#include "assets/high/m67.h"  //409
#include "assets/high/l67.h"  //410

#include "assets/high/f0.h"   //411
#include "assets/high/f1.h"   //412
#include "assets/high/f2.h"   //413
#include "assets/high/f3.h"   //414
#include "assets/high/f4.h"   //415
#include "assets/high/f5.h"   //416
#include "assets/high/f6.h"   //417
#include "assets/high/f7.h"   //418
#include "assets/high/f8.h"   //419
#include "assets/high/f9.h"   //420
#include "assets/high/f10.h"  //421
#include "assets/high/f11.h"  //422
#include "assets/high/f12.h"  //423
#include "assets/high/f13.h"  //424
#include "assets/high/f14.h"  //425
#include "assets/high/f15.h"  //426
#include "assets/high/f16.h"  //427
#include "assets/high/f17.h"  //428
#include "assets/high/f18.h"  //429
#include "assets/high/f19.h"  //430
#include "assets/high/emoji.h"//431


//*************************************
// globals
//*************************************
const char appTitle[]="TuxScape 2";
GLFWwindow* wnd;
uint winw=1024, winh=768, ks[6]={0};
<<<<<<< HEAD
float t=0.f, dt=0.f, lt=0.f, fc=0.f, lfct=0.f, aspect;
=======
float t=0.f, dt=0.f, lt=0.f, fc=0.f, lfct=0.f, fov=30.f, aspect;
>>>>>>> 30c2dae (r1)

// camera vars
#define FAR_DISTANCE 777.f
uint focus_cursor = 0;
uint free_look = 0;
double sens = 0.003;
double mx,my,lx,ly;
float xrot = 0.f;
float yrot = 1.3f;
float dzoom = -0.3f;
float zoom = -1.3f;

// player
uint sid=67; // ship id
int vis=207; // ship render id [207-408]
<<<<<<< HEAD
#define pp ships[sid].pos // ship position
#define pv ships[sid].vel // ship velocity
#define pr ships[sid].rot // ship rot/dir in radians
#define pa ships[sid].accel
#define pb ships[sid].brake
#define pes ships[sid].elev_speed
#define pss ships[sid].straf_speed
#define pts ships[sid].turn_speed
=======
#define pp  ships[sid].pos
#define pv  ships[sid].vel
#define pr  ships[sid].rot
#define pa  ships[sid].accel
#define pb  ships[sid].brake
#define pes ships[sid].elev_speed
#define pss ships[sid].straf_speed
#define pts ships[sid].turn_speed

// ships
>>>>>>> 30c2dae (r1)
typedef struct {float accel,brake,elev_speed,straf_speed,turn_speed,rot;vec pos,vel;} ship;
#define MAX_SHIPS 68
ship ships[MAX_SHIPS];

// emojis
vec emoji[20];


//*************************************
// game functions
//*************************************
void resetGame(uint mode)
{
    sid=67;
    vis=207+(sid*3);

    for(uint i=0; i < 20; i++)
    {
        const float rad=esRandFloat(20.f, 120.f), angle=esRandFloat(-PI, PI);
        emoji[i].x = sinf(angle)*rad;
        emoji[i].y = cosf(angle)*rad;
        emoji[i].z = esRandFloat(-8.f, 8.f);
        emoji[i].w = esRandFloat(-PI, PI); // Zrot in w
    }
    
    //for(uint i=0; i < MAX_SHIPS; i++){ships[i] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f};}
    //for(uint i=0; i < MAX_SHIPS; i++){ships[i] = (ship){esRandFloat(4.20f, 24.f), esRandFloat(1.f, 6.f), esRandFloat(0.25f, 1.f), esRandFloat(0.25f, 1.f), esRandFloat(0.0025f, 0.042f)};}
    ships[0]  = (ship){3.f, 2.3f, 0.5f, 0.5f, 0.005f};
    ships[1]  = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[2]  = (ship){11.3f, 1.93f, 0.5f, 0.67f, 0.015f};
    ships[3]  = (ship){11.3f, 1.93f, 0.5f, 0.25f, 0.015f};
    ships[4]  = (ship){13.37f, 4.20f, 0.33f, 0.22f, 0.033f};
    ships[5]  = (ship){16.67f, 2.22f, 0.75f, 0.33f, 0.0276f};
    ships[6]  = (ship){12.21f, 1.23f, 0.5f, 0.5f, 0.0276f};
    ships[7]  = (ship){8.f, 4.20f, 0.25f, 0.25f, 0.01f};
    ships[8]  = (ship){13.31f, 2.22f, 0.5f, 0.65f, 0.013f}; //a
    ships[9]  = (ship){4.644f, 3.33f, 0.33f, 0.33f, 0.022f};
    ships[10] = (ship){13.31f, 2.22f, 0.5f, 0.65f, 0.013f}; //a
    ships[11] = (ship){13.37f, 1.337f, 0.5f, 0.5f, 0.016f};
    ships[12] = (ship){17.71f, 1.337f, 0.5f, 0.5f, 0.025f};
    ships[13] = (ship){8.88f, 2.333f, 0.23f, 0.23f, 0.016f};
    ships[14] = (ship){16.61f, 1.337f, 0.5f, 0.5f, 0.033f};
    ships[15] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[16] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[17] = (ship){11.f, 2.3f, 0.45f, 0.45f, 0.025f};
    ships[18] = (ship){12.f, 2.73f, 0.42f, 0.42f, 0.032f};
    ships[19] = (ship){10.7f, 2.33f, 0.33f, 0.33f, 0.022f};
    ships[20] = (ship){10.7f, 1.11f, 0.5f, 0.5f, 0.011f};
    ships[21] = (ship){18.81f, 2.22f, 0.4f, 0.4f, 0.023f};
    ships[22] = (ship){18.81f, 3.33f, 0.5f, 0.5f, 0.025f};
    ships[23] = (ship){3.88f, 1.33f, 0.44f, 0.44f, 0.01f};
    ships[24] = (ship){14.41f, 2.22f, 0.44f, 0.44f, 0.0272f};
    ships[25] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[26] = (ship){11.11f, 2.13f, 0.23f, 0.5f, 0.0263f};
    ships[27] = (ship){14.41f, 3.33f, 0.777f, 0.777f, 0.044f};
    ships[28] = (ship){12.21f, 1.11f, 0.6f, 0.6f, 0.033f};
    ships[29] = (ship){2.44f, 1.11f, 0.4f, 0.3f, 0.01f};
    ships[30] = (ship){12.21f, 1.68f, 0.466f, 0.466f, 0.008f};
    ships[31] = (ship){1.33f, 1.11f, 0.3f, 0.4f, 0.01f};
    ships[32] = (ship){9.87f, 1.77f, 0.5f, 0.5f, 0.021f};
    ships[33] = (ship){22.22f, 4.20f, 0.48f, 0.48f, 0.03f};
    ships[34] = (ship){9.88f, 1.66f, 0.48f, 0.48f, 0.03f};
    ships[35] = (ship){13.37f, 1.99f, 0.22f, 0.48f, 0.022f};
    ships[36] = (ship){11.11f, 1.99f, 0.22f, 0.22f, 0.024f};
    ships[37] = (ship){7.77f, 1.99f, 0.22f, 0.44f, 0.023f};
    ships[38] = (ship){10.01f, 2.66f, 0.34f, 0.44f, 0.026f};
    ships[39] = (ship){12.68f, 1.11f, 0.136f, 0.4f, 0.0036f};
    ships[40] = (ship){12.21f, 2.22f, 0.5f, 0.5f, 0.025f};
    ships[41] = (ship){8.88f, 1.11f, 0.38f, 0.38f, 0.018f};
    ships[42] = (ship){6.88f, 0.777f, 0.1333f, 0.1333f, 0.00777f};
    ships[43] = (ship){19.17f, 1.12f, 0.56f, 0.53f, 0.0261620f};
    ships[44] = (ship){44.44f, 5.18f, 0.73f, 0.9f, 0.018f};
    ships[45] = (ship){24.42f, 4.18f, 0.9f, 0.9f, 0.0188f};
    ships[46] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[47] = (ship){10.10f, 2.3f, 0.38f, 0.38f, 0.022f};
    ships[48] = (ship){36.63f, 4.44f, 0.38f, 0.38f, 0.0234f};
    ships[49] = (ship){8.88f, 0.88f, 0.38f, 0.38f, 0.014f};
    ships[50] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[51] = (ship){11.11f, 2.3f, 0.38f, 0.38f, 0.023f};
    ships[52] = (ship){13.31f, 1.6f, 0.63f, 0.36f, 0.018f};
    ships[53] = (ship){48.84f, 3.33f, 0.66f, 0.66f, 0.03f};
    ships[54] = (ship){8.88f, 1.11f, 0.66f, 0.66f, 0.03f};
    ships[55] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    ships[56] = (ship){16.61f, 2.2f, 0.56f, 0.56f, 0.022f};
    ships[57] = (ship){12.21f, 2.2f, 0.56f, 0.56f, 0.027f};
    ships[58] = (ship){3.33f, 0.66f, 0.33f, 0.33f, 0.006f};
    ships[59] = (ship){3.33f, 0.88f, 0.36f, 0.36f, 0.014f};
    ships[60] = (ship){33.33f, 4.24f, 0.26f, 0.36f, 0.019f};
    ships[61] = (ship){11.11f, 3.f, 0.433f, 0.433f, 0.012f};
    ships[62] = (ship){12.21f, 2.3f, 0.34f, 0.34f, 0.021f};
    ships[63] = (ship){15.51f, 3.3f, 0.28f, 0.34f, 0.018f};
<<<<<<< HEAD
    ships[64] = (ship){13.31f, 2.2f, 0.74f, 0.84f, 0.012f};//
    ships[65] = (ship){13.31f, 2.2f, 0.74f, 0.84f, 0.012f};//
=======
    ships[64] = (ship){13.31f, 2.2f, 0.74f, 0.84f, 0.012f};//c
    ships[65] = (ship){13.31f, 2.2f, 0.74f, 0.84f, 0.012f};//c
>>>>>>> 30c2dae (r1)
    ships[66] = (ship){6.6f, 2.2f, 0.33f, 0.33f, 0.012f};
    ships[67] = (ship){9.f, 2.3f, 0.5f, 0.5f, 0.025f}; //b
    for(uint i=0; i < MAX_SHIPS; i++)
    {
<<<<<<< HEAD
=======
        if(i == sid){continue;}
>>>>>>> 30c2dae (r1)
        const float rad = esRandFloat(20.f, 120.f);
        const float angle = esRandFloat(-PI, PI);
        ships[i].pos.x = sinf(angle)*rad;
        ships[i].pos.y = cosf(angle)*rad;
        ships[i].pos.z = esRandFloat(-8.f, 8.f);
        ships[i].vel = (vec){0.f,0.f,0.f};
        ships[i].rot = esRandFloat(-PI, PI);
    }

    dzoom = -0.3f;
    zoom = -1.3f;
    xrot = -7.019932f;
    yrot =  1.431000f;
<<<<<<< HEAD

    sid=67;
    vis=207+(sid*3);
=======
    pp = (vec){-12.738008f, -13.827285f, 2.864779f};
    pv = (vec){0.f, 0.f, 0.f};
    pr = 7.019940f;
>>>>>>> 30c2dae (r1)

    if(mode == 1)
    {
        char strts[16];
        timestamp(&strts[0]);
        printf("[%s] Game Reset.\n", strts);
    }
    glfwSetWindowTitle(wnd, appTitle);
}

//*************************************
// update & render
//*************************************
void main_loop()
{
//*************************************
// core logic
//*************************************
    fc++;
    glfwPollEvents();
    t = (float)glfwGetTime();
    dt = t-lt;
    lt = t;

#ifdef WEB
    EmscriptenPointerlockChangeEvent e;
    if(emscripten_get_pointerlock_status(&e) == EMSCRIPTEN_RESULT_SUCCESS)
    {
        if(focus_cursor == 0 && e.isActive == 1)
        {
            glfwGetCursorPos(wnd, &lx, &ly);
        }
        focus_cursor = e.isActive;
    }
#endif

//*************************************
// game logic
//*************************************

    // inputs
    if(ks[2] == 1) // W
    {
        pv.x += sinf(pr)*pa*dt;
        pv.y += cosf(pr)*pa*dt;
    }
    else if(ks[3] == 1) // S
    {
        pv.x -= sinf(pr)*pa*dt;
        pv.y -= cosf(pr)*pa*dt;
    }
    ///
    if(ks[0] == 1) // A
    {
        pv.x += sinf(pr-d2PI)*pa*pss*dt;
        pv.y += cosf(pr-d2PI)*pa*pss*dt;
    }
    else if(ks[1] == 1) // D
    {
        pv.x -= sinf(pr-d2PI)*pa*pss*dt;
        pv.y -= cosf(pr-d2PI)*pa*pss*dt;
    }
    ///
    if(ks[4] == 1) // SPACE
    {
        pv.z += pa*pes*dt;
    }
    else if(ks[5] == 1) // SHIFT
    {
        pv.z -= pa*pes*dt;
    }

    // ship braking
    pv.x *= 1.f-(pb*dt);
    pv.y *= 1.f-(pb*dt);
    pv.z *= 1.f-(pb*dt);

    // ship pos
    pp.x += pv.x*dt;
    pp.y += pv.y*dt;
    pp.z += pv.z*dt;

    // zoom glide
    dzoom += (zoom-dzoom)*3.f*dt;

    // camera
    if(focus_cursor == 1)
    {
        glfwGetCursorPos(wnd, &mx, &my);

        xrot += (float)((lx-mx)*sens);
        yrot += (float)((ly-my)*sens);

        if(yrot > d2PI){yrot = d2PI;}
        if(yrot < 0.5f){yrot = 0.5f;}

        lx = mx, ly = my;
    }
    mIdent(&view);
    mSetPos(&view, (vec){0.f, 0.f, dzoom});
    mRotate(&view, yrot, 1.f, 0.f, 0.f);
    mRotate(&view, xrot, 0.f, 0.f, 1.f);
    mTranslate(&view, -pp.x, -pp.y+0.017f, -pp.z-0.075f);

    //printf("%f %f %f %f %f %f \n", pp.x, pp.y, pp.z, pr, xrot, yrot);

//*************************************
// render
//*************************************

    // clear buffer
    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

    ///

    // render planets/islands
    toView();
    esBindRender(2); // so you don't get lost in space; tabby cat star will guide you.
    for(uint i=0; i<207; i++)
    {
        // ship sphere collision with planet/island?
        const float ppd = vDistSq(esModelArray[i].pos,  pp);
        if(ppd > 4444.f){continue;}else if(ppd > 1111.f)
        {
            glEnable(GL_BLEND);
<<<<<<< HEAD
            glUniform1f(opacity_id, 1.f-((ppd-1111.f)/3333.f));
=======
            glUniform1f(opacity_id, 1.f-((ppd-1111.f)*0.00030003f));
>>>>>>> 30c2dae (r1)
        }
        if(ppd < esModelArray[i].rsq*3.3f)
        {
            const uint niter = esModelArray[i].nv*3;
            vec bump = (vec){0.f, 0.f, 0.f}; // force against collision (bump back dir)
            float bump_acc = 0.f; // total to divide bump by at end
            for(uint j = 0; j < niter; j+=3) // check if the ship hit any vertices and correct course
            {
                const float vx = esModelArray[i].vertices[j],
                            vy = esModelArray[i].vertices[j+1],
                            vz = esModelArray[i].vertices[j+2];
                if(vDistSq((vec){vx, vy, vz}, pp) < esModelArray[vis].rsq)
                {
                    bump.x += esModelArray[i].normals[j];
                    bump.y += esModelArray[i].normals[j+1];
                    bump.z += esModelArray[i].normals[j+2];
                    bump_acc+=1.f;
                    // could improve by checking if the normal is
                    // within 180 degree facing the ship before summation.
                }
            }
            if(bump_acc > 0.f)
            {
                bump.x /= bump_acc;
                bump.y /= bump_acc;
                bump.z /= bump_acc;
                // pp.x += bump.x*0.16f*dt;
                // pp.y += bump.y*0.16f*dt;
                // pp.z += bump.z*0.16f*dt;
                pv = (vec){bump.x*pa*dt,
                           bump.y*pa*dt,
                           bump.z*pa*dt};
            }
        }

        // render
        if(i != 2){esBindRender(i);} 
        if(ppd > 1111.f){glDisable(GL_BLEND);}
<<<<<<< HEAD
    }

    // render player ships
    float prd = 0.f;
    if(free_look < 2) // ship rotation
    {
        prd = -(pr+xrot)*pts;
        if(free_look == 1 && fabsf(prd) < 0.0006f){free_look=2;}
        pr += prd*200.f*dt;
    }
    for(uint i=0; i < MAX_SHIPS; i++)
    {
        // colliding with the player controlled ship?
        if(i != sid)
        {
            const float dj = vDistSq(ships[i].pos, pp);
            if(dj <= (esModelArray[207+i].rsq+esModelArray[207+sid].rsq)*2.f)
            {
                pv = (vec){pp.x-ships[i].pos.x, pp.y-ships[i].pos.y, pp.z-ships[i].pos.z};
                vNorm(&pv);
                pv = (vec){pv.x*pa*dt, pv.y*pa*dt, pv.z*pa*dt};
            }
        }

        // colliding with another ship?
        // for(uint j=0; j < MAX_SHIPS; j++)
        // {
        //     if(j==i){continue;}
        //     const float dj = vDistSq(ships[j].pos, ships[i].pos);
        //     if(dj <= (esModelArray[207+i].rsq+esModelArray[207+j].rsq)*2.f)
        //     {
        //         //pv = (vec){0.f, 0.f, 0.f};
        //         ships[i].vel = (vec){ships[i].pos.x-ships[j].pos.x,
        //                              ships[i].pos.y-ships[j].pos.y,
        //                              ships[i].pos.z-ships[j].pos.z};
        //         vNorm(&ships[i].vel);
        //         ships[i].vel = (vec){ships[i].vel.x*pa*dt, ships[i].vel.y*pa*dt, ships[i].vel.z*pa*dt};
        //     }
        // }

        // rotations
        mIdent(&model);
        mSetPos(&model, ships[i].pos);
        if(free_look == 0) // ship rotation
        {
            mRotZ(&model, ships[i].rot);
            if(i==sid){mRotX(&model, -prd*50.f);}
        }
        else if(i==sid && free_look == 1)
        {
            mRotZ(&model, ships[i].rot);
            mRotX(&model, -prd*50.f);
        }
        else
        {
            mRotZ(&model, ships[i].rot);
        }
        updateModelView();

        // distance lod, alpha blend distance fade, and render
        const float spd = vDistSq(ships[i].pos, pp);
        if(spd > 4444.f){continue;}else if(spd > 1111.f)
        {
            glEnable(GL_BLEND);
            glUniform1f(opacity_id, 1.f-((spd-1111.f)/3333.f));
        }
        uint lod = 0;
        if(spd > 333.f){lod=2;}
        else if(spd > 60.f){lod=1;}
        esBindRender(207+(i*3)+lod);
        if(spd > 1111.f){glDisable(GL_BLEND);}
    }
=======
    }
    
    // render emojis
    esBindModel(431);
    for(uint i=0; i < 20; i++)
    {
        if(emoji[i].w <= -444.f){continue;}
        
        mIdent(&model);
        mSetPos(&model, emoji[i]);

        const float pfd = vDistSq(emoji[i],  pp);
        if(pfd > 1111.f){continue;}else if(pfd > 0.f)
        {
            glEnable(GL_BLEND);
            glUniform1f(opacity_id, 1.f-(pfd*0.00090009f));
        }

        if(emoji[i].w == -333.f)
        {
            const vec fpos = esModelArray[411+i].pos;
            vec t;
            vSub(&t, fpos, emoji[i]);
            vNorm(&t);
            mSetDir(&model, t);
            vMulS(&t, t, dt*3.f);
            vAdd(&emoji[i], emoji[i], t);
            const float d = vDistSq(emoji[i], fpos);
            if(d < 0.001f){emoji[i].w = -444.f;if(pfd > 0.f){glDisable(GL_BLEND);}continue;}
            else if(d < 222.f){mScale1(&model, d*0.004504505f);}
        }
        else
        {
            const float d = vDistSq(pp, emoji[i]);
            if(d <= 0.3f)
            {
                emoji[i].w = -333.f;
            }
            else if(d <= 24.f)
            {
                mRotZ(&model, emoji[i].w+d);
                mRotY(&model, (emoji[i].w*0.5f)+(d*0.5f));
                mRotX(&model, (emoji[i].w*0.25f)+(d*0.75f));
            }
            else
            {
                mRotZ(&model, emoji[i].w);
                mRotY(&model, emoji[i].w*0.5f);
                mRotX(&model, emoji[i].w*0.25f);
            }
        }

        updateModelView();
        esRenderModel();
        if(pfd > 0.f){glDisable(GL_BLEND);}
    }

    // render friends
    for(uint i=0; i<20; i++)
    {
        if(emoji[i].w <= -444.f)
        {
            // ship collision with friend
            const float ppd = vDistSq(esModelArray[411+i].pos,  pp);
            if(ppd > 4444.f){continue;}else if(ppd > 1111.f)
            {
                glEnable(GL_BLEND);
                glUniform1f(opacity_id, 1.f-((ppd-1111.f)*0.00030003f));
            }
            if(ppd < esModelArray[411+i].rsq*3.3f)
            {
                const uint niter = esModelArray[411+i].nv*3;
                vec bump = (vec){0.f, 0.f, 0.f}; // force against collision (bump back dir)
                float bump_acc = 0.f; // total to divide bump by at end
                for(uint j = 0; j < niter; j+=3) // check if the ship hit any vertices and correct course
                {
                    const float vx = esModelArray[411+i].vertices[j],
                                vy = esModelArray[411+i].vertices[j+1],
                                vz = esModelArray[411+i].vertices[j+2];
                    if(vDistSq((vec){vx, vy, vz}, pp) < esModelArray[vis].rsq)
                    {
                        bump.x += esModelArray[411+i].normals[j];
                        bump.y += esModelArray[411+i].normals[j+1];
                        bump.z += esModelArray[411+i].normals[j+2];
                        bump_acc+=1.f;
                        // could improve by checking if the normal is
                        // within 180 degree facing the ship before summation.
                    }
                }
                if(bump_acc > 0.f)
                {
                    bump.x /= bump_acc;
                    bump.y /= bump_acc;
                    bump.z /= bump_acc;
                    // pp.x += bump.x*0.16f*dt;
                    // pp.y += bump.y*0.16f*dt;
                    // pp.z += bump.z*0.16f*dt;
                    pv = (vec){ bump.x*pa*dt,
                                bump.y*pa*dt,
                                bump.z*pa*dt };
                }
            }

            // fade in / render
            const float d = -(emoji[i].w+444.f);
            if(d < 1.f)
            {
                glEnable(GL_BLEND);
                glUniform1f(opacity_id, d);
            }
            toView();
            esBindRender(411+i);
            if(d < 1.f)
            {
                glDisable(GL_BLEND);
                emoji[i].w -= 0.42f*dt;
            }
        }
    }
    
    // render player ships
    float prd = 0.f;
    if(free_look < 2) // ship rotation
    {
        prd = -(pr+xrot)*pts;
        if(free_look == 1 && fabsf(prd) < 0.0006f){free_look=2;}
        pr += prd*200.f*dt;
    }
    for(uint i=0; i < MAX_SHIPS; i++)
    {
        // colliding with the player controlled ship?
        if(i != sid)
        {
            const float dj = vDistSq(ships[i].pos, pp);
            if(dj <= (esModelArray[207+i].rsq+esModelArray[vis].rsq)*2.f)
            {
                pv = (vec){pp.x-ships[i].pos.x, pp.y-ships[i].pos.y, pp.z-ships[i].pos.z};
                vNorm(&pv);
                pv = (vec){pv.x*pa*dt, pv.y*pa*dt, pv.z*pa*dt};
            }
        }

        // colliding with another ship?
        // for(uint j=0; j < MAX_SHIPS; j++)
        // {
        //     if(j==i){continue;}
        //     const float dj = vDistSq(ships[j].pos, ships[i].pos);
        //     if(dj <= (esModelArray[207+i].rsq+esModelArray[207+j].rsq)*2.f)
        //     {
        //         //pv = (vec){0.f, 0.f, 0.f};
        //         ships[i].vel = (vec){ships[i].pos.x-ships[j].pos.x,
        //                              ships[i].pos.y-ships[j].pos.y,
        //                              ships[i].pos.z-ships[j].pos.z};
        //         vNorm(&ships[i].vel);
        //         ships[i].vel = (vec){ships[i].vel.x*pa*dt, ships[i].vel.y*pa*dt, ships[i].vel.z*pa*dt};
        //     }
        // }

        // rotations
        mIdent(&model);
        mSetPos(&model, ships[i].pos);
        if(free_look == 0) // ship rotation
        {
            mRotZ(&model, ships[i].rot);
            if(i==sid){mRotX(&model, -prd*50.f);}
        }
        else if(i==sid && free_look == 1)
        {
            mRotZ(&model, ships[i].rot);
            mRotX(&model, -prd*50.f);
        }
        else
        {
            mRotZ(&model, ships[i].rot);
        }
        updateModelView();

        // distance lod, alpha blend distance fade, and render
        const float spd = vDistSq(ships[i].pos, pp);
        if(spd > 4444.f){continue;}else if(spd > 1111.f)
        {
            glEnable(GL_BLEND);
            glUniform1f(opacity_id, 1.f-((spd-1111.f)*0.00030003f));
        }
        uint lod = 0;
        if(spd > 333.f){lod=2;}
        else if(spd > 60.f){lod=1;}
        esBindRender(207+(i*3)+lod);
        if(spd > 1111.f){glDisable(GL_BLEND);}
    }
>>>>>>> 30c2dae (r1)

    ///

    // display render
    glfwSwapBuffers(wnd);
}

//*************************************
// input
//*************************************
void key_callback(GLFWwindow* wnd, int key, int scancode, int action, int mods)
{
    if(focus_cursor == 0){return;}
    if(action == GLFW_PRESS)
    {
        if(     key == GLFW_KEY_LEFT  || key == GLFW_KEY_A){ks[0]=1;}
        else if(key == GLFW_KEY_RIGHT || key == GLFW_KEY_D){ks[1]=1;}
        else if(key == GLFW_KEY_UP    || key == GLFW_KEY_W){ks[2]=1;}
        else if(key == GLFW_KEY_DOWN  || key == GLFW_KEY_S){ks[3]=1;}
        else if(key == GLFW_KEY_SPACE)                     {ks[4]=1;}
        else if(key == GLFW_KEY_LEFT_SHIFT ||
                key == GLFW_KEY_RIGHT_SHIFT)               {ks[5]=1;}
        else if(key == GLFW_KEY_E)
        {
            uint nid=sid;
            float nd=0.16f;
            for(uint i=0; i < MAX_SHIPS; i++)
            {
                if(i==sid){continue;}
                const float d = vDistSq(ships[i].pos, pp);
                if(d < nd)
                {
                    nid = i;
                    nd = d;
                }
            }
            if(nid != sid)
            {
                ships[sid].vel = (vec){0.f,0.f,0.f};
                sid = nid;
                xrot = -ships[sid].rot;
            }
        }
        else if(key == GLFW_KEY_F) // show average fps
        {
            if(t-lfct > 2.0)
            {
                char strts[16];
                timestamp(&strts[0]);
                printf("[%s] FPS: %g\n", strts, fc/(t-lfct));
                lfct = t;
                fc = 0;
            }
        }
        else if(key == GLFW_KEY_R) // reset game
        {
            resetGame(1);
        }
        else if(key == GLFW_KEY_C)
        {
            if(fov==60.f){fov=30.f;}else{fov=60.f;}
            window_size_callback(wnd, winw, winh);
        }
        else if(key == GLFW_KEY_ESCAPE)
        {
            focus_cursor = 0;
#ifndef WEB
            glfwSetInputMode(wnd, GLFW_CURSOR, GLFW_CURSOR_NORMAL);
            glfwGetCursorPos(wnd, &lx, &ly);
#endif
        }
    }
    else if(action == GLFW_RELEASE)
    {
        if(     key == GLFW_KEY_LEFT  || key == GLFW_KEY_A){ks[0]=0;}
        else if(key == GLFW_KEY_RIGHT || key == GLFW_KEY_D){ks[1]=0;}
        else if(key == GLFW_KEY_UP    || key == GLFW_KEY_W){ks[2]=0;}
        else if(key == GLFW_KEY_DOWN  || key == GLFW_KEY_S){ks[3]=0;}
        else if(key == GLFW_KEY_SPACE)                     {ks[4]=0;}
        else if(key == GLFW_KEY_LEFT_SHIFT ||
                key == GLFW_KEY_RIGHT_SHIFT)               {ks[5]=0;}
    }
}
void scroll_callback(GLFWwindow* wnd, double xoffset, double yoffset)
{
    if(focus_cursor == 0){return;}

    // if(yoffset < 0.0){vis-=3;sid--;}else{vis+=3;sid++;}
    // if(vis < 207){vis=408;sid=67;}else if(vis > 408){vis=207;sid=0;}
    // xrot = -ships[sid].rot;
    // //printf("[S-%u] %g %g %g %g %g\n",sid,pa,pb,pes,pss,pts);

    if(yoffset < 0.0){zoom += 0.24f * zoom;}else{zoom -= 0.24f * zoom;}
    if(zoom > -0.33f){zoom = -0.33f;}else if(zoom < -1.3f){zoom = -1.3f;}
}
void mouse_button_callback(GLFWwindow* wnd, int button, int action, int mods)
{
    if(action != GLFW_PRESS)
    {
        if(focus_cursor == 1 && button == GLFW_MOUSE_BUTTON_RIGHT){free_look=0;}
        return;
    }
    if(button == GLFW_MOUSE_BUTTON_LEFT)
    {
        if(focus_cursor == 0)
        {
            focus_cursor = 1;
#ifndef WEB
            glfwSetInputMode(wnd, GLFW_CURSOR, GLFW_CURSOR_DISABLED);
            glfwGetCursorPos(wnd, &lx, &ly);
#endif
        }
        else // shoot
        {
            //
        }
    }
    else if(button == GLFW_MOUSE_BUTTON_RIGHT){free_look = 1;}
}
void window_size_callback(GLFWwindow* wnd, int width, int height)
{
    winw = width, winh = height;
    glViewport(0, 0, winw, winh);
    aspect = (float)winw / (float)winh;
    mIdent(&projection);
    mPerspective(&projection, fov, aspect, 0.01f, FAR_DISTANCE);  // 30 and 60 are good here
    glUniformMatrix4fv(projection_id, 1, GL_FALSE, (float*)&projection.m[0][0]);
}
#ifdef WEB
EM_BOOL emscripten_resize_event(int eventType, const EmscriptenUiEvent *uiEvent, void *userData)
{
    winw = uiEvent->documentBodyClientWidth;
    winh = uiEvent->documentBodyClientHeight;
    window_size_callback(wnd, winw, winh);
    emscripten_set_canvas_element_size("canvas", winw, winh);
    return EM_FALSE;
}
#endif

//*************************************
// process entry point
//*************************************
int main(int argc, char** argv)
{
    // generate asset loading functions
    // uint gi=0;
    // for(NULL; gi < 207; gi++)
    //     printf("#include \"assets/high/p%u.h\"  //%u\n", gi, gi);
    // puts("");
    // for(uint i=0; i < 67; i++)
    // {
    //     printf("#include \"assets/high/h%u.h\"  //%u\n", i, gi++);
    //     printf("#include \"assets/high/m%u.h\"  //%u\n", i, gi++);
    //     printf("#include \"assets/high/l%u.h\"  //%u\n", i, gi++);
    // }
    // // generate asset loading functions
    // for(uint i=0; i < 207; i++)
    //     printf("register_p%u();", i);
    // puts("");
    // for(uint i=0; i < 67; i++)
    // {
    //     printf("register_h%u();", i);
    //     printf("register_m%u();", i);
    //     printf("register_l%u();", i);
    // }
    // return 0;

    // regular start
    int msaa = 16;
#ifdef WEB
    focus_cursor = 0;
#endif

    // help
    printf("----\n");
    printf("James William Fletcher (github.com/mrbid)\n");
    printf("%s - Inspir3d by RunEscape.\n", appTitle);
    printf("----\n");
#ifndef WEB
    // allow custom msaa level
    if(argc >= 2){msaa = atoi(argv[1]);}

    printf("One command line argument, msaa 0-16.\n");
    printf("e.g; ./tuxscape2 16\n");
    printf("----\n");
#endif
    // printf("Q = Push to Talk\n");
    printf("Scroll = Zoom Camera\n");
    printf("Mouse Move = Rotate Camera & Ship Direction\n");
    printf("W,A,S,D / Arrow Keys = Fly Directions\n");
    //printf("Left Click = Shoot\n");
    printf("Right Click = Hold for free look camera.\n");
    printf("Space / Shift = Up and Down altitude.\n");
    printf("E = Steal Nearby Ship\n");
<<<<<<< HEAD
    printf("F = FPS to console.\n");
=======
    printf("C = Change FOV.\n");
>>>>>>> 30c2dae (r1)
    printf("R = Reset game.\n");
    printf("F = FPS to console.\n");
    printf("----\n");
    printf("All assets generated using LUMA GENIE (https://lumalabs.ai/genie).\n");
    printf("----\n");
    printf("%s\n", glfwGetVersionString());
    printf("----\n");

    // init glfw
    if(!glfwInit()){printf("glfwInit() failed.\n"); exit(EXIT_FAILURE);}
#ifdef WEB
    double width, height;
    emscripten_get_element_css_size("body", &width, &height);
    winw = (uint)width, winh = (uint)height;
#endif
    glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 2);
    glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 0);
    glfwWindowHint(GLFW_SAMPLES, msaa);
    wnd = glfwCreateWindow(winw, winh, appTitle, NULL, NULL);
    if(!wnd){printf("glfwCreateWindow() failed.\n");glfwTerminate();exit(EXIT_FAILURE);}
    const GLFWvidmode* desktop = glfwGetVideoMode(glfwGetPrimaryMonitor());
#ifndef WEB
    glfwSetWindowPos(wnd, (desktop->width/2)-(winw/2), (desktop->height/2)-(winh/2)); // center window on desktop
    if(focus_cursor == 1)
    {
        glfwGetCursorPos(wnd, &lx, &ly);
        glfwSetInputMode(wnd, GLFW_CURSOR, GLFW_CURSOR_DISABLED);
    }
#endif
    glfwSetWindowSizeCallback(wnd, window_size_callback);
    glfwSetKeyCallback(wnd, key_callback);
    glfwSetMouseButtonCallback(wnd, mouse_button_callback);
    glfwSetScrollCallback(wnd, scroll_callback);
    glfwMakeContextCurrent(wnd);
    gladLoadGL(glfwGetProcAddress);
    glfwSwapInterval(1); // 0 for immediate updates, 1 for updates synchronized with the vertical retrace, -1 for adaptive vsync

    // set icon
    glfwSetWindowIcon(wnd, 1, &(GLFWimage){16, 16, (unsigned char*)icon_image});

//*************************************
// bind vertex and index buffers
//*************************************

    // all of the "planets" 0-206 (207)
    register_p0();register_p1();register_p2();register_p3();register_p4();register_p5();register_p6();
    register_p7();register_p8();register_p9();register_p10();register_p11();register_p12();register_p13();
    register_p14();register_p15();register_p16();register_p17();register_p18();register_p19();register_p20();
    register_p21();register_p22();register_p23();register_p24();register_p25();register_p26();register_p27();
    register_p28();register_p29();register_p30();register_p31();register_p32();register_p33();register_p34();
    register_p35();register_p36();register_p37();register_p38();register_p39();register_p40();register_p41();
    register_p42();register_p43();register_p44();register_p45();register_p46();register_p47();register_p48();
    register_p49();register_p50();register_p51();register_p52();register_p53();register_p54();register_p55();
    register_p56();register_p57();register_p58();register_p59();register_p60();register_p61();register_p62();
    register_p63();register_p64();register_p65();register_p66();register_p67();register_p68();register_p69();
    register_p70();register_p71();register_p72();register_p73();register_p74();register_p75();register_p76();
    register_p77();register_p78();register_p79();register_p80();register_p81();register_p82();register_p83();
    register_p84();register_p85();register_p86();register_p87();register_p88();register_p89();register_p90();
    register_p91();register_p92();register_p93();register_p94();register_p95();register_p96();register_p97();
    register_p98();register_p99();register_p100();register_p101();register_p102();register_p103();register_p104();
    register_p105();register_p106();register_p107();register_p108();register_p109();register_p110();register_p111();
    register_p112();register_p113();register_p114();register_p115();register_p116();register_p117();register_p118();
    register_p119();register_p120();register_p121();register_p122();register_p123();register_p124();register_p125();
    register_p126();register_p127();register_p128();register_p129();register_p130();register_p131();register_p132();
    register_p133();register_p134();register_p135();register_p136();register_p137();register_p138();register_p139();
    register_p140();register_p141();register_p142();register_p143();register_p144();register_p145();register_p146();
    register_p147();register_p148();register_p149();register_p150();register_p151();register_p152();register_p153();
    register_p154();register_p155();register_p156();register_p157();register_p158();register_p159();register_p160();
    register_p161();register_p162();register_p163();register_p164();register_p165();register_p166();register_p167();
    register_p168();register_p169();register_p170();register_p171();register_p172();register_p173();register_p174();
    register_p175();register_p176();register_p177();register_p178();register_p179();register_p180();register_p181();
    register_p182();register_p183();register_p184();register_p185();register_p186();register_p187();register_p188();
    register_p189();register_p190();register_p191();register_p192();register_p193();register_p194();register_p195();
    register_p196();register_p197();register_p198();register_p199();register_p200();register_p201();register_p202();
    register_p203();register_p204();register_p205();register_p206();

    // ships hq,mq,lq 0-67 (68)
    register_h0();register_m0();register_l0();register_h1();register_m1();register_l1();register_h2();
    register_m2();register_l2();register_h3();register_m3();register_l3();register_h4();register_m4();
    register_l4();register_h5();register_m5();register_l5();register_h6();register_m6();register_l6();
    register_h7();register_m7();register_l7();register_h8();register_m8();register_l8();register_h9();
    register_m9();register_l9();register_h10();register_m10();register_l10();register_h11();register_m11();
    register_l11();register_h12();register_m12();register_l12();register_h13();register_m13();register_l13();
    register_h14();register_m14();register_l14();register_h15();register_m15();register_l15();register_h16();
    register_m16();register_l16();register_h17();register_m17();register_l17();register_h18();register_m18();
    register_l18();register_h19();register_m19();register_l19();register_h20();register_m20();register_l20();
    register_h21();register_m21();register_l21();register_h22();register_m22();register_l22();register_h23();
    register_m23();register_l23();register_h24();register_m24();register_l24();register_h25();register_m25();
    register_l25();register_h26();register_m26();register_l26();register_h27();register_m27();register_l27();
    register_h28();register_m28();register_l28();register_h29();register_m29();register_l29();register_h30();
    register_m30();register_l30();register_h31();register_m31();register_l31();register_h32();register_m32();
    register_l32();register_h33();register_m33();register_l33();register_h34();register_m34();register_l34();
    register_h35();register_m35();register_l35();register_h36();register_m36();register_l36();register_h37();
    register_m37();register_l37();register_h38();register_m38();register_l38();register_h39();register_m39();
    register_l39();register_h40();register_m40();register_l40();register_h41();register_m41();register_l41();
    register_h42();register_m42();register_l42();register_h43();register_m43();register_l43();register_h44();
    register_m44();register_l44();register_h45();register_m45();register_l45();register_h46();register_m46();
    register_l46();register_h47();register_m47();register_l47();register_h48();register_m48();register_l48();
    register_h49();register_m49();register_l49();register_h50();register_m50();register_l50();register_h51();
    register_m51();register_l51();register_h52();register_m52();register_l52();register_h53();register_m53();
    register_l53();register_h54();register_m54();register_l54();register_h55();register_m55();register_l55();
    register_h56();register_m56();register_l56();register_h57();register_m57();register_l57();register_h58();
    register_m58();register_l58();register_h59();register_m59();register_l59();register_h60();register_m60();
    register_l60();register_h61();register_m61();register_l61();register_h62();register_m62();register_l62();
    register_h63();register_m63();register_l63();register_h64();register_m64();register_l64();register_h65();
    register_m65();register_l65();register_h66();register_m66();register_l66();register_h67();register_m67();
    register_l67();

    // friends 0-19 +Emoji (21)
    register_f0();register_f1();register_f2();register_f3();register_f4();register_f5();register_f6();
    register_f7();register_f8();register_f9();register_f10();register_f11();register_f12();register_f13();
    register_f14();register_f15();register_f16();register_f17();register_f18();register_f19();register_emoji();
    
//*************************************
// configure render options
//*************************************
    makeLambert();

    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);

    glEnable(GL_CULL_FACE);
    glEnable(GL_DEPTH_TEST);

    glClearColor(0.f, 0.f, 0.f, 0.f);

    shadeLambert(&position_id, &projection_id, &modelview_id, &lightpos_id, &normal_id, &color_id, &ambient_id, &saturate_id, &opacity_id);
    glUniform1f(ambient_id, 0.26f);
    glUniform1f(saturate_id, 1.0f);
    window_size_callback(wnd, winw, winh);

#ifdef GL_DEBUG
    esDebug(1);
#endif

//*************************************
// execute update / render loop
//*************************************

    // init
    srand(time(0));
    srandf(time(0));
    glfwSetTime(0.0);

    // game init
    resetGame(0);

    // loop
#ifdef WEB
    emscripten_set_resize_callback(EMSCRIPTEN_EVENT_TARGET_WINDOW, NULL, EM_FALSE, emscripten_resize_event);
    emscripten_set_main_loop(main_loop, 0, 1);
#else
    while(!glfwWindowShouldClose(wnd)){main_loop();}
#endif

    // done
    glfwDestroyWindow(wnd);
    glfwTerminate();
    exit(EXIT_SUCCESS);
    return 0;
}
